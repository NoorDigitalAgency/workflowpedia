name: Checkout
on:
  workflow_call:
    inputs:
      stage:
        description: Stage
        type: string
        required: true
      commit:
        description: Commit Id
        type: string
        default: ''
jobs:
  checkout:
    runs-on: ubuntu-20.04
    name: Checkout
    steps:
      - uses: actions/checkout@v2
        name: Branch Checkout
        with:
          submodules: 'recursive'
      - uses: actions/github-script@v6
        id: analyzing
        name: Analyzing
        with:
          script: |
              const stage = '${{ inputs.stage }}';
              if (stage !== 'production' && stage !== 'beta' && stage !== 'alpha')
              {
                core.setFailed(`Invalid stage name '${stage}'.`);
                return;
              }
              const commit = '${{ inputs.commit }}'.trim();
              const branch = stage === 'alpha' ? 'develop' : stage === 'beta' ? 'release' : 'main';
              const detached = commit !== '' && commit !== branch;
              await exec.exec('git', ['fetch', '--all']);
              const correctBranch = !detached || (await exec.getExecOutput('git', ['branch', '-r', '--contains', commit]))
                                                 .stdout.split('\n').filter(line => line.trim() !== '').map(line => line.trim().split('/').pop())
                                                 .includes(branch);
              return { branch, detached, correctBranch, commit };
      - if: fromJSON(steps.analyzing.outputs.result).correctBranch != true
        name: Fail
        uses: actions/github-script@v6
        with:
          script: core.setFailed("The commit '${{ fromJSON(steps.analyzing.outputs.result).commit }}' doesn't exist on branch '${{ fromJSON(steps.analyzing.outputs.result).branch }}'.");
      - uses: actions/checkout@v2
        name: Commit Checkout
        with:
          ref: ${{ fromJSON(steps.analyzing.outputs.result).commit }}
          submodules: 'recursive'
